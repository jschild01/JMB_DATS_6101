---
title: "LendingClub Peer-to-Peer Loan Analysis"
author: "Jonathan Schild, Medhasweta Sen, Brian Gulko"
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    number_sections: true
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes=
    toc_depth: '3'
---

```{r setup, include=FALSE}
# We want the results to be hidden by default, though for some chunks we will override this to show the results
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
```

# Introduction
Peer-to-peer (P2P) was a phenomenon less than ten years ago, exploding in popularity by offering a break from traditional banking. Individuals flocked to the alternative credit markets as alternative sources of funding and for new opportunities to finance their small business ventures.  

Although direct P2P lending has undergone changes over recent years, it remains a viable option for borrowers and investors. We are seeking to understand the factors that might have signalled risky loans or borrowing practices and could be consumed or applied by prospective borrowers, lenders, and/or investors considering participating in direct P2P. 


## Our Data
Our dataset contains over 9,500 observations of loan data from LendingClub, the largest online platform for direct P2P lending.^[https://www.kaggle.com/datasets/urstrulyvikas/lending-club-loan-data-analysis] We believe that the timeframe of 2007 to 2015 provides the most relevant data for prospective individual investors today, particularly because it is unlikely to include a significant number of large institutional lenders. Our variables are defined as:

```{r results = "show"}
# This is copied form the Kaggle site
# We will use a kable table for simplicity
data_definitions <- data.frame(variable = c("credit.policy", "purpose", "int.rate", "installment", "log.annual.inc", "dti", "fico", "days.with.cr.line", "revol.bal", "revol.util", "inq.last.6mths", "delinq.2yrs", "pub.rec", "not.fully.paid"),
                          definition = c("1 if the customer meets the credit underwriting criteria of LendingClub.com, and 0 otherwise.",
                                         "The purpose of the loan (takes values creditcard, debtconsolidation, educational, majorpurchase, smallbusiness, and all_other).",
                                         "The interest rate of the loan, as a proportion (a rate of 11% would be stored as 0.11). Borrowers judged by LendingClub.com to be more risky are assigned higher interest rates.",
                                         "The monthly installments owed by the borrower if the loan is funded.",
                                         "The natural log of the self-reported annual income of the borrower.",
                                         "The debt-to-income ratio of the borrower (amount of debt divided by annual income).",
                                         "The FICO credit score of the borrower.",
                                         "The number of days the borrower has had a credit line.",
                                         "The borrower's revolving balance (amount unpaid at the end of the credit card billing cycle).",
                                         "The borrower's revolving line utilization rate (the amount of the credit line used relative to total credit available).",
                                         "The borrower's number of inquiries by creditors in the last 6 months.",
                                         "The number of times the borrower had been 30+ days past due on a payment in the past 2 years.",
                                         "The borrower's number of derogatory public records (bankruptcy filings, tax liens, or judgments).",
                                         "Whether the borrower will be fully paid or not."))

knitr::kable(data_definitions)
```


# Exploratory Data Analysis
Our exploratory data analysis will adhere to the 9-step^[Back to original] checklist presented in Chapter 4 of *The Art of Data Science*.^[Peng, Roger D., and Elizabeth Matsui. “Chapter 4.” The Art of Data Science: A Guide for Anyone Who Works with Data, Skybrude Consulting LLC, Victoria, 2016, pp. 33–33.] These are the elements of our checklist:

1. Formulate our question
2. Read in our data
3. Check the packaging
4. Look at the top and the bottom of your data
5. Check your "n"s
6. Validate with at least one external data source
7. Make a plot
8. Try the easy solution first
9. Follow up


## Formulate our question
Our analysis explored things such as income-to-debt ratios, credit score, interest rates, and delinquencies among direct P2P borrowers in an attempt to understand the risks and opportunities associated with P2P. Specifically, we intend to examine the impact that these variables have on who received loans and who defaulted on their loans between 2007 and 2015. 


## Read in our data
We start by loading the tidyverse and ezids libraries^[Our code requires the tidyverse and ezids libraries.] and reading on our dataset.
```{r}
library(ezids) # We will use functions form this package to get nicer looking results
library(tidyverse) # We need this package for data manipulation, piping, and graphing
library(corrplot) # We will need this package to plot the correlation matrix
library(scales) # This package will help us when labeling the scatter plots
# Read in the data from the working directory
loans <- read_csv("lending_club_loan_data.csv")
```


## Check the packaging
We can see that our dataset contains `r nrow(loans)` rows of data with `r ncol(loans)` columns. Next let's examine the structure of the dataset.
```{r results = "show"}
# There is unfortunately no ezids function to see the result in a nice looking table, so we will use the standard function.
str(loans)
```

By examining the structure of our data, we can see that there is only one character variable which might be a factor, and some of the numeric variables look like logicals.


## Look at the top and the bottom of your data
We can also look at the top and bottom rows of our dataset to get a better feel for the data.

The top of our dataset:
```{r results = "show"}
# We use the xkabledplyhead() function form the ezids package to see the result in a nice looking table.
xkabledplyhead(loans)
```

The bottom of our dataset:
```{r results = "show"}
# We use the xkabledplytail() function form the ezids package to see the result in a nice looking table.
xkabledplytail(loans)
```

The top and bottom rows of our dataset indicate the data is structured in an acceptable way and that our variables match up with the values for each column.


## Check your "n"s
We can get some descriptive statistics of the variables to help us better understand the data.
```{r results = "show"}
# We use the xkablesummary() function from the ezids package to see the result in a nice looking table.
xkablesummary(loans)
```

From this we can see that some of the variables that appeared to be logicals, like inq.last.6mths, delinq.2yrs, and pub.rec are actually not.

We have an idea of what to expect for a few variables, such as interest rate and credit score, so we were table to test the dataset against some of our expectations to gauge its reliability. By inspecting the dataframe, we can see that interest rates for the data are between `r paste0(min(loans$int.rate)*100,"%")` and `r paste0(max(loans$int.rate)*100,"%")` and credit scores range from `r min(loans$fico)` to `r max(loans$fico)`. Although interest rates might seem to reach excessively high rates or credit scores too meager, the P2P market tended to consist of more risky loans. This aligned with our expectation and reinforced our confidence in the dataset. 

The range of the utilization, or the percent of credit being used, is between `r paste0(min(loans$revol.util), "%")` and `r paste0(max(loans$revol.util), "%")`. Someone utilizing more than 100% of the credit available to them initially seemed erroneous; however, this can occur from technical error, creditors and collectors reporting at different date/times, borrowers opening and closing credit lines, or possibly when borrowers appear as authorized users of others’ credit lines. Regardless, only `r sum(loans$revol.util > 100)` loans within our dataset appear to exceed the standard maximum of 100% so we do not expect this to have a significant effect on our analysis.


## Validate with at least one external data source
According to the Kaggle site where we got this dataset from, there are 9,578 rows and 14 columns, which matches what we have. The site also shows that there is no missing data. Let's verify that by adding the total number of missing cells in the dataset, which is `r sum(is.na(loans))`.


## Make a plot
Let's make a histogram for each non-logical numeric variable.
```{r fig.width=8}
# By gathering the variables we want to see into a long format with the gather() function, we can then create a histogram
# for each variable using the facet_wrap() function in ggplot2.
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec) %>%
  gather(variable, value) %>%
  ggplot(aes(x = value)) +
  geom_histogram(fill = "steelblue", color = "black") +
  facet_wrap(~ variable, scales = "free") + # Free scales so the graphs are readable
  labs(title = "Histograms of Numeric Variables", x = "Value", y = "Count") +
  theme_minimal()
```

Some of these variables look somewhat normal, and it would make sense to create a QQ-Plot for them later. But first let's create boxplots for these same variables.
```{r fig.width=8}
# By gathering the variables we want to see into a long format with the gather() function, we can then create a boxplot
# for each variable using the facet_wrap() function in ggplot2.
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec) %>%
  gather(variable, value) %>%
  ggplot(aes(x = value)) +
  geom_boxplot(fill = "steelblue", color = "black",
               outlier.size = 2, outlier.alpha = 0.2) + # Translucent and larger outliers to help with overplotting
  facet_wrap(~ variable, scales = "free") + # Free scales so the graphs are readable
  labs(title = "Boxplots of Numeric Variables", x = "Value") +
  theme_minimal() +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())
```

We can see that some of these variables have issues with outliers.

Now let's look at the Factor and logical variables with bar charts.
```{r fig.width=8}
# By gathering the variables we want to see into a long format with the gather() function, we can then create a bar graph
# for each variable using the facet_wrap() function in ggplot2.
loans %>%
  select(credit.policy, purpose, not.fully.paid) %>%
  gather(variable, value) %>%
  ggplot(aes(x = value)) +
  geom_bar(fill = "steelblue", color = "black") +
  facet_wrap(~ variable, scales = "free") + # Free scales so the graphs are readable
  coord_flip() +
  labs(title = "Bar Charts of Non-Numeric Variables", x = "Value", y = "Count") +
  theme_minimal() +
  theme()
```

From this we can see that the `purpose` variable would be a good candidate to perform ANOVA tests on. 


## Try the easy solution first
Let's try the easy way of looking at meeting the credit underwriting criteria vs the borrower fully paying. We can group by the credit.policy variable, and calculate the percentage of borrowers in each category who did not fully pay.
```{r results = "Show"}
# We will convert the average to an easier to read percentage by multiplying by 100, rounding, and adding a "%" at the end.
loans %>%
  group_by(credit.policy) %>%
  summarize(percent_not_fully_paid = paste0(round(100*mean(not.fully.paid), 1), "%"))  %>%
  ungroup() %>%
  knitr::kable(align = "c")
```



From this we can see that about 13.2% of borrowers who met the credit underwriting criteria did not fully pay, while for the borrowers who did not meet the credit underwriting criteria about 27.8% did not fully pay. 

This indicates borrowers who did not meet the credit underwriting criteria were almost twice as likely to be default on their loans than those who did meet the criteria. For comparison, default rates on loans from commercial banks for the same period as our dataset averaged 4.48%, with a maximum default rate of 7.49% default rate towards the end of 2009, according to the St. Louis Federal Reserve Bank.^[https://fred.stlouisfed.org/series/DRALACBN#]


## Follow up

Let us go back to the table of data definitions and add a column for the variable type.

```{r}
# Add a type column and reorder it so that definition is last
data_definitions_augmented <- data_definitions %>%
  mutate(type = c("Logical", "Factor", "Numeric", "Numeric", "Numeric", "Numeric", "Integer", "Numeric", "Integer", "Numeric", "Integer", "Integer", "Integer", "Logical")) %>%
  select(variable, type, definition)
```

```{r results = "show"}
# We will use a kable table for simplicity
knitr::kable(data_definitions_augmented)
```


Let's also convert some of the variables to a more appropriate type. the `credit.policy` and `not.fully.paid` variables are logicals, and the `purpose` variable we will use as a factor.
```{r}
# These variables may act differently from here on out
loans$credit.policy <- as.logical(loans$credit.policy)
loans$not.fully.paid <- as.logical(loans$not.fully.paid)

loans$purpose <- as.factor(loans$purpose)
```

Now we can further explore the data to see how the numeric variables differ based on the on the `credit.policy`, `not.fully.paid`, and `purpose` variables. Let's make some boxplots to visualize this.

### Additional Boxplots
```{r}
# By gathering the variables we want to see into a long format with the gather() function, we can then create a boxplot
# for each variable using the facet_wrap() function in ggplot2. We can see this for each credit policy value by excluding
# it in the gather() function.
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec, credit.policy) %>%
  gather(variable, value, -credit.policy) %>%
  ggplot(aes(x = value, y = as.logical(credit.policy), fill = as.logical(credit.policy))) +
  geom_boxplot(outlier.size = 2, outlier.alpha = 0.2) +  # Translucent and larger outliers to help with overplotting
  guides(fill = guide_legend(reverse = TRUE)) + # So the legend order matches the order in the graphs
  facet_wrap(~ variable, scales = "free_x") + # Free x scale so the graphs are readable
  labs(title = "Boxplots of Numeric Variables", subtitle = "Comparing `credit.policy` Values",
       x = "Value", y = "Count", fill = "Credit Policy") +
  theme_minimal()

# By gathering the variables we want to see into a long format with the gather() function, we can then create a boxplot
# for each variable using the facet_wrap() function in ggplot2. We can see this for each not fully paid value by excluding
# it in the gather() function.
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec, not.fully.paid) %>%
  gather(variable, value, -not.fully.paid) %>%
  ggplot(aes(x = value, y = as.logical(not.fully.paid), fill = as.logical(not.fully.paid))) +
  geom_boxplot(outlier.size = 2, outlier.alpha = 0.2) +  # Translucent and larger outliers to help with overplotting
  guides(fill = guide_legend(reverse = TRUE)) + # So the legend order matches the order in the graphs
  facet_wrap(~ variable, scales = "free_x") + # Free x scale so the graphs are readable
  labs(title = "Boxplots of Numeric Variables", subtitle = "Comparing `not.fully.paid` Values",
       x = "Value", y = "Count", fill = "Not Fully Paid") +
  theme_minimal()

# By gathering the variables we want to see into a long format with the gather() function, we can then create a boxplot
# for each variable using the facet_wrap() function in ggplot2. We can see this for each purpose value by excluding
# it in the gather() function.
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec, purpose) %>%
  gather(variable, value, -purpose) %>%
  ggplot(aes(x = value, y = purpose, fill = purpose)) +
  geom_boxplot(outlier.size = 2, outlier.alpha = 0.2) +
  guides(fill = guide_legend(reverse = TRUE)) + # So the legend order matches the order in the graphs
  facet_wrap(~ variable, scales = "free_x") + # Free x scale so the graphs are readable
  labs(title = "Boxplots of Numeric Variables", subtitle = "Comparing `purpose` Values",
       x = "Value", y = "Count", fill = "Purpose") +
  theme_minimal()
```

### Correlation Matrix
```{r fig.width=7, fig.height=7}
# For our correlation matrix we want to include everything but the purpose variable
loans_correlation_matrix <- loans %>%
  select(-purpose) %>%
  cor()

# The mixed correlation plot makes a nice visualization
corrplot.mixed(loans_correlation_matrix, tl.pos = "lt")
```

### Scatter Plots
```{r}
loans %>%
  ggplot(aes(x = fico, y = int.rate)) +
  geom_point(color = "steelblue", alpha = 0.2) +
  labs(title = "Interest Rate vs FICO Score",
       x = "FICO Score", y = "Interest Rate") +
  scale_x_continuous(limits = c(600, NA), expand = expansion(mult = c(0, .05))) +
  scale_y_continuous(labels = label_percent(), limits = c(.05, NA), expand = expansion(mult = c(0, .05))) +
  theme_minimal()

loans %>%
  ggplot(aes(x = int.rate, y = revol.util)) +
  geom_point(color = "steelblue", alpha = 0.2) +
  labs(title = "Revolving Line Utilization Rate vs Interest Rate",
       x = "Interest Rate", y = "Revolving Line Utilization Rate") +
  scale_x_continuous(labels = label_percent(), limits = c(.05, NA), expand = expansion(mult = c(0, .05))) +
  scale_y_continuous(labels = label_percent(scale = 1)) +
  theme_minimal()

loans %>%
  ggplot(aes(x = log.annual.inc, y = installment)) +
  geom_point(color = "steelblue", alpha = 0.2) +
  labs(title = "Installment vs Log of Annual Income",
       x = "Log of Annual Income", y = "Installment") +
  theme_minimal()

loans %>%
  ggplot(aes(x = fico, y = revol.util)) +
  geom_point(color = "steelblue", alpha = 0.2) +
  labs(title = "Revolving Line Utilization Rate vs FICO Score",
       x = "FICO Score", y = "Revolving Line Utilization Rate") +
  scale_x_continuous(limits = c(600, NA), expand = expansion(mult = c(0, .05))) +
  scale_y_continuous(labels = label_percent(scale = 1)) +
  theme_minimal()
```



# Statistical Tests
Interpretation^[https://towardsdatascience.com/end-to-end-case-study-classification-lending-club-data-489f8a1b100a] ^[https://towardsdatascience.com/turning-lending-clubs-worst-loans-into-investment-gold-475ec97f58ee] ^[https://www.debt.org/credit/loans/personal/lending-club-review/] ^[https://nycdatascience.com/blog/student-works/lendingclub-profitability-predictions/] ^[https://nycdatascience.com/blog/student-works/project-1-analysis-of-lending-clubs-data/] ^[https://michel-kana.medium.com/lendingclub-bias-in-data-machine-learning-and-investment-strategy-3a3bd1c65f0]


```{r}
# This code will perform the z-interval tests we want, but  we will show the results in a nicer looking table format
# For the purpose of these z-interval tests we are suuming that the data is n ormal and therefore has a standard deviation of 2.31
loadPkg("BSDA")
ztest95rate = z.test(x=loans$int.rate, sigma.x = sd(loans$int.rate)) # default conf.level = 0.95
ztest95rate
ztest99rate = z.test(x=loans$int.rate, sigma.x = 2.31, conf.level=0.99 )
ztest99rate
ztest50rate = z.test(x=loans$int.rate, sigma.x = 2.31, conf.level=0.50 )
ztest50rate
```

```{r results = "Show"}
# Table of z-interval test results
```


```{r}
ztest95installment = z.test(x=loans$installment, sigma.x = 2.31) # default conf.level = 0.95
ztest95installment
ztest99installment = z.test(x=loans$installment, sigma.x = 2.31, conf.level=0.99 )
ztest99installment
ztest50installment = z.test(x=loans$installment, sigma.x = 2.31, conf.level=0.50 )
ztest50installment
```

```{r}
ztest95annual = z.test(x=loans$log.annual.inc, sigma.x = 2.31) # default conf.level = 0.95
ztest95annual
ztest99annual = z.test(x=loans$log.annual.inc, sigma.x = 2.31, conf.level=0.99 )
ztest99annual
ztest50annual = z.test(x=loans$log.annual.inc, sigma.x = 2.31, conf.level=0.50 )
ztest50annual

```

```{r}
ztest95fico = z.test(x=loans$fico, sigma.x = 2.31) # default conf.level = 0.95
ztest95fico
ztest99fico = z.test(x=loans$fico, sigma.x = 2.31, conf.level=0.99 )
ztest99fico
ztest50fico = z.test(x=loans$fico, sigma.x = 2.31, conf.level=0.50 )
ztest50fico
```

```{r}
ztest95dti = z.test(x=loans$dti, sigma.x = 2.31) # default conf.level = 0.95
ztest95dti
ztest99dti = z.test(x=loans$dti, sigma.x = 2.31, conf.level=0.99 )
ztest99dti
ztest50dti = z.test(x=loans$dti, sigma.x = 2.31, conf.level=0.50 )
ztest50dti
```

```{r}
ztest95days.with.cr.line = z.test(x=loans$days.with.cr.line, sigma.x = 2.31) # default conf.level = 0.95
ztest95days.with.cr.line
ztest99days.with.cr.line = z.test(x=loans$days.with.cr.line, sigma.x = 2.31, conf.level=0.99 )
ztest99days.with.cr.line
ztest50days.with.cr.line = z.test(x=loans$days.with.cr.line, sigma.x = 2.31, conf.level=0.50 )
ztest50days.with.cr.line
```

```{r}
ztest95revol.bal = z.test(x=loans$revol.bal, sigma.x = 2.31) # default conf.level = 0.95
ztest95revol.bal
ztest99revol.bal = z.test(x=loans$revol.bal, sigma.x = 2.31, conf.level=0.99 )
ztest99revol.bal
ztest50revol.bal = z.test(x=loans$revol.bal, sigma.x = 2.31, conf.level=0.50 )
ztest50revol.bal

```

```{r}
ztest95revol.util = z.test(x=loans$revol.util, sigma.x = 2.31) # default conf.level = 0.95
ztest95revol.util
ztest99revol.util = z.test(x=loans$revol.util, sigma.x = 2.31, conf.level=0.99 )
ztest99revol.util
ztest50revol.util = z.test(x=loans$revol.util, sigma.x = 2.31, conf.level=0.50 )
ztest50revol.util
```

```{r}
ztest95inq.last.6mths = z.test(x=loans$inq.last.6mths, sigma.x = 2.31) # default conf.level = 0.95
ztest95inq.last.6mths
ztest99inq.last.6mths = z.test(x=loans$inq.last.6mths, sigma.x = 2.31, conf.level=0.99 )
ztest99inq.last.6mths
ztest50inq.last.6mths = z.test(x=loans$inq.last.6mths, sigma.x = 2.31, conf.level=0.50 )
ztest50inq.last.6mths

```

```{r}
ztest95delinq.2yrs = z.test(x=loans$delinq.2yrs, sigma.x = 2.31) # default conf.level = 0.95
ztest95delinq.2yrs
ztest99delinq.2yrs = z.test(x=loans$delinq.2yrs, sigma.x = 2.31, conf.level=0.99 )
ztest99delinq.2yrs
ztest50delinq.2yrs = z.test(x=loans$delinq.2yrs, sigma.x = 2.31, conf.level=0.50 )
ztest50delinq.2yrs

```

```{r}
ztest95pub.rec = z.test(x=loans$pub.rec, sigma.x = 2.31) # default conf.level = 0.95
ztest95pub.rec
ztest99pub.rec = z.test(x=loans$pub.rec, sigma.x = 2.31, conf.level=0.99 )
ztest99pub.rec
ztest50pub.rec = z.test(x=loans$pub.rec, sigma.x = 2.31, conf.level=0.50 )
ztest50pub.rec

```

```{r}
ttest95rate = t.test(x=loans$int.rate) # default conf.level = 0.95
ttest95rate
ttest99rate = t.test(x=loans$int.rate, conf.level=0.99 )
ttest99rate
ttest50rate = t.test(x=loans$int.rate, conf.level=0.50 )
ttest50rate

```

```{r}
ttest95installment = t.test(x=loans$installment) # default conf.level = 0.95
ttest95installment
ttest99installment = t.test(x=loans$installment, conf.level=0.99 )
ttest99installment
ttest50installment = t.test(x=loans$installment, conf.level=0.50 )
ttest50installment

```

```{r}
ttest95annual = t.test(x=loans$log.annual.inc) # default conf.level = 0.95
ttest95annual
ttest99annual = t.test(x=loans$log.annual.inc, conf.level=0.99 )
ttest99annual
ttest50annual = t.test(x=loans$log.annual.inc, conf.level=0.50 )
ttest50annual

```

```{r}
ttest95fico = t.test(x=loans$fico) # default conf.level = 0.95
ttest95fico
ttest99fico = t.test(x=loans$fico, conf.level=0.99 )
ttest99fico
ttest50fico = t.test(x=loans$fico, conf.level=0.50 )
ttest50fico

```

```{r}
ttest95dti = t.test(x=loans$dti) # default conf.level = 0.95
ttest95dti
ttest99dti = t.test(x=loans$dti, conf.level=0.99 )
ttest99dti
ttest50dti = t.test(x=loans$dti, conf.level=0.50 )
ttest50dti

```

```{r}
ttest95days.with.cr.line = t.test(x=loans$days.with.cr.line) # default conf.level = 0.95
ttest95days.with.cr.line
ttest99days.with.cr.line = t.test(x=loans$days.with.cr.line, conf.level=0.99 )
ttest99days.with.cr.line
ttest50days.with.cr.line = t.test(x=loans$days.with.cr.line, conf.level=0.50 )
ttest50days.with.cr.line
```

```{r}
ttest95revol.bal = t.test(x=loans$revol.bal) # default conf.level = 0.95
ttest95revol.bal
ttest99revol.bal = t.test(x=loans$revol.bal, conf.level=0.99 )
ttest99revol.bal
ttest50revol.bal = t.test(x=loans$revol.bal, conf.level=0.50 )
ttest50revol.bal
```

```{r}
ttest95revol.util = t.test(x=loans$revol.util) # default conf.level = 0.95
ttest95revol.util
ttest99revol.util = t.test(x=loans$revol.util, conf.level=0.99 )
ttest99revol.util
ttest50revol.util = t.test(x=loans$revol.util, conf.level=0.50 )
ttest50revol.util
```

```{r}
ttest95inq.last.6mths = t.test(x=loans$inq.last.6mths) # default conf.level = 0.95
ttest95inq.last.6mths
ttest99inq.last.6mths = t.test(x=loans$inq.last.6mths, conf.level=0.99 )
ttest99inq.last.6mths
ttest50inq.last.6mths = t.test(x=loans$inq.last.6mths, conf.level=0.50 )
ttest50inq.last.6mths
```

```{r}
ttest95delinq.2yrs = t.test(x=loans$delinq.2yrs) # default conf.level = 0.95
ttest95delinq.2yrs
ttest99delinq.2yrs = t.test(x=loans$delinq.2yrs, conf.level=0.99 )
ttest99delinq.2yrs
ttest50delinq.2yrs = t.test(x=loans$delinq.2yrs, conf.level=0.50 )
ttest50delinq.2yrs
```

```{r}
ttest95pub.rec = t.test(x=loans$pub.rec) # default conf.level = 0.95
ttest95pub.rec
ttest99pub.rec = t.test(x=loans$pub.rec, conf.level=0.99 )
ttest99pub.rec
ttest50pub.rec = t.test(x=loans$pub.rec, conf.level=0.50 )
ttest50pub.rec
```

## ANOVA Tests

The `purpose` variable in our data is a good candidate to perform ANOVA tests with. We will do an ANOVA test for each variable based on `purpose`, doing Tuckey tests where appropriate.

```{r results = "show"}
aovrate=aov(int.rate ~ purpose, data = loans)
aovratesummary=summary(aovrate)
aovratesummary
aovrateturkey=TukeyHSD(aovrate)
aovrateturkey
```

Explanation


```{r results = "show"}
aovinstallment=aov(installment ~ purpose, data = loans)
aovinstallmentsummary=summary(aovinstallment)
aovinstallmentsummary
aovinstallmentturkey=TukeyHSD(aovinstallment)
aovinstallmentturkey
```

```{r results = "show"}
aovannual=aov(log.annual.inc ~ purpose, data = loans)
aovannualsummary=summary(aovannual)
aovannualsummary
aovannualturkey=TukeyHSD(aovannual)
aovannualturkey
```

```{r results = "show"}
aovdti=aov(dti ~ purpose, data = loans)
aovdtisummary=summary(aovdti)
aovdtisummary
aovdtiturkey=TukeyHSD(aovdti)
aovdtiturkey
```

```{r results = "show"}
aovfico=aov(fico ~ purpose, data = loans)
aovficosummary=summary(aovfico)
aovficosummary
aovficoturkey=TukeyHSD(aovfico)
aovficoturkey
```

```{r results = "show"}
aovcrline=aov(days.with.cr.line ~ purpose, data = loans)
aovcrlinesummary=summary(aovcrline)
aovcrlinesummary
aovcrlineturkey=TukeyHSD(aovcrline)
aovcrlineturkey
```

```{r results = "show"}
aovrbal=aov(revol.bal ~ purpose, data = loans)
aovrbalsummary=summary(aovrbal)
aovrbalsummary
aovrbalturkey=TukeyHSD(aovrbal)
aovrbalturkey
```

```{r results = "show"}
aovrutil=aov(revol.util ~ purpose, data = loans)
aovrutilsummary=summary(aovrutil)
aovrutilsummary
aovrutilturkey=TukeyHSD(aovrutil)
aovrutilturkey
```

```{r results = "show"}
aov6mts=aov(inq.last.6mths ~ purpose, data = loans)
aov6mtssummary=summary(aov6mts)
aov6mtssummary
aov6mtsturkey=TukeyHSD(aov6mts)
aov6mtsturkey
```

```{r results = "show"}
aov2yrs=aov(delinq.2yrs ~ purpose, data = loans)
aov2yrssummary=summary(aov2yrs)
aov2yrssummary
aov2yrsturkey=TukeyHSD(aov2yrs)
aov2yrsturkey
```

```{r results = "show"}
aovpubrec=aov(pub.rec ~ purpose, data = loans)
aovpubrecsummary=summary(aovpubrec)
aovpubrecsummary
aovpubrecturkey=TukeyHSD(aovpubrec)
aovpubrecturkey
```

```{r results = "show"}
aovrate=aov(int.rate ~ credit.policy, data = loans)
aovratesummary=summary(aovrate)
aovratesummary
```

```{r results = "show"}
aovinstallment=aov(installment ~ credit.policy, data = loans)
aovinstallmentsummary=summary(aovinstallment)
aovinstallmentsummary
```

```{r results = "show"}
aovannual=aov(log.annual.inc ~ credit.policy, data = loans)
aovannualsummary=summary(aovannual)
aovannualsummary
```

```{r results = "show"}
aovdti=aov(dti ~ credit.policy, data = loans)
aovdtisummary=summary(aovdti)
aovdtisummary
```

```{r results = "show"}
aovfico=aov(fico ~ credit.policy, data = loans)
aovficosummary=summary(aovfico)
aovficosummary
```

```{r results = "show"}
aovcrline=aov(days.with.cr.line ~ credit.policy, data = loans)
aovcrlinesummary=summary(aovcrline)
aovcrlinesummary
```

```{r results = "show"}
aovrbal=aov(revol.bal ~ credit.policy, data = loans)
aovrbalsummary=summary(aovrbal)
aovrbalsummary
```

```{r results = "show"}
aovrutil=aov(revol.util ~ credit.policy, data = loans)
aovrutilsummary=summary(aovrutil)
aovrutilsummary
```

```{r results = "show"}
aov6mts=aov(inq.last.6mths ~ credit.policy, data = loans)
aov6mtssummary=summary(aov6mts)
aov6mtssummary
```

```{r results = "show"}
aov2yrs=aov(delinq.2yrs ~ credit.policy, data = loans)
aov2yrssummary=summary(aov2yrs)
aov2yrssummary
```

```{r results = "show"}
aovpubrec=aov(pub.rec ~ credit.policy, data = loans)
aovpubrecsummary=summary(aovpubrec)
aovpubrecsummary
```

```{r results = "show"}
aovrate=aov(int.rate ~ not.fully.paid, data = loans)
aovratesummary=summary(aovrate)
aovratesummary
```

```{r results = "show"}
aovinstallment=aov(installment ~ not.fully.paid, data = loans)
aovinstallmentsummary=summary(aovinstallment)
aovinstallmentsummary
```

```{r results = "show"}
aovannual=aov(log.annual.inc ~ not.fully.paid, data = loans)
aovannualsummary=summary(aovannual)
aovannualsummary
```

```{r results = "show"}
aovdti=aov(dti ~ not.fully.paid, data = loans)
aovdtisummary=summary(aovdti)
aovdtisummary
```

```{r results = "show"}
aovfico=aov(fico ~ not.fully.paid, data = loans)
aovficosummary=summary(aovfico)
aovficosummary
```

```{r results = "show"}
aovcrline=aov(days.with.cr.line ~ not.fully.paid, data = loans)
aovcrlinesummary=summary(aovcrline)
aovcrlinesummary
```

```{r results = "show"}
aovrbal=aov(revol.bal ~ not.fully.paid, data = loans)
aovrbalsummary=summary(aovrbal)
aovrbalsummary
```

```{r results = "show"}
aovrutil=aov(revol.util ~ not.fully.paid, data = loans)
aovrutilsummary=summary(aovrutil)
aovrutilsummary
```

```{r results = "show"}
aov6mts=aov(inq.last.6mths ~ not.fully.paid, data = loans)
aov6mtssummary=summary(aov6mts)
aov6mtssummary
```

```{r results = "show"}
aov2yrs=aov(delinq.2yrs ~ not.fully.paid, data = loans)
aov2yrssummary=summary(aov2yrs)
aov2yrssummary
```

```{r results = "show"}
aovpubrec=aov(pub.rec ~ not.fully.paid, data = loans)
aovpubrecsummary=summary(aovpubrec)
aovpubrecsummary
```

## Chi Squared Test


```{r}
test = chisq.test(table(loans$purpose,loans$credit.policy))
test
```
```{r}
test$observed
```
```{r}
test$expected
```
```{r}
test$residuals
```
```{r}
library(corrplot)
corrplot(test$residuals, is.cor = FALSE)
```

```{r}
test = chisq.test(table(loans$purpose,loans$not.fully.paid))
test
```
```{r}
test$observed
```
```{r}
test$expected
```
```{r}
test$residuals
```
```{r}
library(corrplot)
corrplot(test$residuals, is.cor = FALSE)
```

```{r}
test = chisq.test(table(loans$credit.policy,loans$not.fully.paid))
test
```
```{r}
test$observed
```
```{r}
test$expected
```
```{r}
test$residuals
```
```{r}
library(corrplot)
corrplot(test$residuals, is.cor = FALSE)
```


## Standard Deviation
```{r}
sd(loans$int.rate)
sd(loans$installment)
sd(loans$log.annual.inc)
sd(loans$dti)
sd(loans$fico)
sd(loans$days.with.cr.line)
sd(loans$revol.bal)
sd(loans$revol.util)
sd(loans$inq.last.6mths)
sd(loans$delinq.2yrs)
sd(loans$pub.rec)
```


## Correlationa nd Covariance
```{r}
cov(loans$int.rate,loans$installment)
cor(loans$int.rate,loans$installment)
cov(loans$int.rate,loans$log.annual.inc)
cor(loans$int.rate,loans$log.annual.inc)
cov(loans$int.rate,loans$dti)
cor(loans$int.rate,loans$dti)
cov(loans$int.rate,loans$fico)
cor(loans$int.rate,loans$fico)
cov(loans$int.rate,loans$days.with.cr.line)
cor(loans$int.rate,loans$days.with.cr.line)
cov(loans$int.rate,loans$revol.bal)
cor(loans$int.rate,loans$revol.bal)
cov(loans$int.rate,loans$revol.util)
cor(loans$int.rate,loans$revol.util)
cov(loans$int.rate,loans$inq.last.6mths)
cor(loans$int.rate,loans$inq.last.6mths)
cov(loans$int.rate,loans$delinq.2yrs)
cor(loans$int.rate,loans$delinq.2yrs)
cov(loans$int.rate,loans$pub.rec)
cor(loans$int.rate,loans$pub.rec)
cov(loans$installment,loans$log.annual.inc)
cor(loans$installment,loans$log.annual.inc)
cov(loans$installment,loans$dti)
cor(loans$installment,loans$dti)
cov(loans$installment,loans$fico)
cor(loans$installment,loans$fico)
cov(loans$installment,loans$days.with.cr.line)
cor(loans$installment,loans$days.with.cr.line)
cov(loans$installment,loans$revol.bal)
cor(loans$installment,loans$revol.bal)
cov(loans$installment,loans$revol.util)
cor(loans$installment,loans$revol.util)
cov(loans$installment,loans$inq.last.6mths)
cor(loans$installment,loans$inq.last.6mths)
cov(loans$installment,loans$delinq.2yrs)
cor(loans$installment,loans$delinq.2yrs)
cov(loans$installment,loans$pub.rec)
cor(loans$installment,loans$pub.rec)
cov(loans$log.annual.inc,loans$dti)
cor(loans$log.annual.inc,loans$dti)
cov(loans$log.annual.inc,loans$fico)
cor(loans$log.annual.inc,loans$fico)
cov(loans$log.annual.inc,loans$days.with.cr.line)
cor(loans$log.annual.inc,loans$days.with.cr.line)
cov(loans$log.annual.inc,loans$revol.bal)
cor(loans$log.annual.inc,loans$revol.bal)
cov(loans$log.annual.inc,loans$revol.util)
cor(loans$log.annual.inc,loans$revol.util)
cov(loans$log.annual.inc,loans$inq.last.6mths)
cor(loans$log.annual.inc,loans$inq.last.6mths)
cov(loans$log.annual.inc,loans$delinq.2yrs)
cor(loans$log.annual.inc,loans$delinq.2yrs)
cov(loans$log.annual.inc,loans$pub.rec)
cor(loans$log.annual.inc,loans$pub.rec)
cov(loans$dti,loans$fico)
cor(loans$dti,loans$fico)
cov(loans$dti,loans$days.with.cr.line)
cor(loans$dti,loans$days.with.cr.line)
cov(loans$dti,loans$revol.bal)
cor(loans$dti,loans$revol.bal)
cov(loans$dti,loans$revol.util)
cor(loans$dti,loans$revol.util)
cov(loans$dti,loans$inq.last.6mths)
cor(loans$dti,loans$inq.last.6mths)
cov(loans$dti,loans$delinq.2yrs)
cor(loans$dti,loans$delinq.2yrs)
cov(loans$dti,loans$pub.rec)
cor(loans$dti,loans$pub.rec)
cov(loans$fico,loans$days.with.cr.line)
cor(loans$fico,loans$days.with.cr.line)
cov(loans$fico,loans$revol.bal)
cor(loans$fico,loans$revol.bal)
cov(loans$fico,loans$revol.util)
cor(loans$fico,loans$revol.util)
cov(loans$fico,loans$inq.last.6mths)
cor(loans$fico,loans$inq.last.6mths)
cov(loans$fico,loans$delinq.2yrs)
cor(loans$fico,loans$delinq.2yrs)
cov(loans$fico,loans$pub.rec)
cor(loans$fico,loans$pub.rec)
cov(loans$days.with.cr.line,loans$revol.bal)
cor(loans$days.with.cr.line,loans$revol.bal)
cov(loans$days.with.cr.line,loans$revol.util)
cor(loans$days.with.cr.line,loans$revol.util)
cov(loans$days.with.cr.line,loans$inq.last.6mths)
cor(loans$days.with.cr.line,loans$inq.last.6mths)
cov(loans$days.with.cr.line,loans$delinq.2yrs)
cor(loans$days.with.cr.line,loans$delinq.2yrs)
cov(loans$days.with.cr.line,loans$pub.rec)
cor(loans$days.with.cr.line,loans$pub.rec)
cov(loans$revol.bal,loans$revol.util)
cor(loans$revol.bal,loans$revol.util)
cov(loans$revol.bal,loans$inq.last.6mths)
cor(loans$revol.bal,loans$inq.last.6mths)
cov(loans$revol.bal,loans$delinq.2yrs)
cor(loans$revol.bal,loans$delinq.2yrs)
cov(loans$revol.bal,loans$pub.rec)
cor(loans$revol.bal,loans$pub.rec)
cov(loans$revol.util,loans$inq.last.6mths)
cor(loans$revol.util,loans$inq.last.6mths)
cov(loans$revol.util,loans$delinq.2yrs)
cor(loans$revol.util,loans$delinq.2yrs)
cov(loans$revol.util,loans$pub.rec)
cor(loans$revol.util,loans$pub.rec)
cov(loans$inq.last.6mths,loans$delinq.2yrs)
cor(loans$inq.last.6mths,loans$delinq.2yrs)
cov(loans$inq.last.6mths,loans$pub.rec)
cor(loans$inq.last.6mths,loans$pub.rec)
cov(loans$delinq.2yrs,loans$pub.rec)
cor(loans$delinq.2yrs,loans$pub.rec)
```


## Q-Q Plots
```{r}
loans %>%
  select(int.rate, installment, log.annual.inc, dti, fico, days.with.cr.line, revol.bal, revol.util,
           inq.last.6mths, delinq.2yrs, pub.rec) %>%
  gather(variable, value) %>%
  ggplot(aes(sample = value)) +
  geom_qq(color = "steelblue") +
  geom_qq_line() +
  facet_wrap(~ variable, scales = "free") + # Free scales so the graphs are readable
  labs(title = "Q-Q Plots of Numeric Variables", x = "Theoretical", y = "Sample") +
  theme_minimal()
```


# Conclusion and Next Steps

Risks to our analysis and opportunities for future analyses:

Private individuals historically made up the bulk of lenders in P2P markets. However, high interest rates and the prospects of risky borrowers undermined P2P lending as a legitimate financial industry. Combined with the urge for more growth by intermediaries like LendingClub, these concerns began to prompt higher lending standards and discussions about more regulation. 

By 2017, shortly after the peak of the P2P industry, larger institutions and banks began to take over private individuals as the primary sources of lending in P2P markets. We suspect/assume this shift in P2P lenders altered the makeup of who receives what, thereby rendering recent research on P2P loans as an investment opportunity less reliable as a guide for today’s prospective individual investors.


Conclusions?

Next Steps?



